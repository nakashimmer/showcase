<!DOCTYPE html>
<html>
	<head>
		<!-- Google Analytics -->
		<script src="/showcase/ga.js"></script>
		<meta charset=utf-8>
		<title>習字</title>
		<meta name="viewport" content="width=device-width">
		<link rel="stylesheet" href="../../../../sample.css">
		<style>
			#wrap {
				background: black;
			}

			canvas {
				display: block;
				margin: 0 auto;
				box-shadow: 3px 3px 10px -2px white	;
			}

			button {
				display: block;
				margin: 1em auto;
				font-size: 1.2em;
				padding: 0.5em 1em;
				border-radius: 10px;
				border:none;
				box-shadow: 3px 3px 10px -2px white	;
			}

			#hiddenLink {
				display: none;
			}
		</style>
	</head>
	<body>
		<h1>習字</h1>
		<div id="wrap">
			<p><canvas id="canvas" width="400" height="500"></canvas></p>
			<p><a id="hiddenLink" download="canvas.png">link</a></p>
			<p><button onclick="downloadCanvas()">習字をダウンロード</button>
				<button onclick="clr()">クリア</button>
			</p>
		</div>
		<footer>
			<p><small>(C)<a href="https://www.facebook.com/NakashimaShunji/">なかしまぁ先生</a></small>
			</p>
		</footer>
		<script>
			const canvas = document.getElementById("canvas");
			const c = canvas.getContext('2d');

			const fude = { x: 0, y: 0, d: 0 };
			const fude2 = { x: 0, y: 0, d: 0 };
			let draw = false;

			clr();

			c.fillStyle = "black";
			c.shadowBlur = 5;
			c.shadowColor = "black";

			//筆先------
			//mouse ---------------------------------------
			canvas.addEventListener("mousedown", function (e) {
				draw = true;
				c.globalAlpha = 1;
				fudesaki(fude.x, fude.y - 5, -8);
				savePos();
			});
			canvas.addEventListener("mousemove", function (e) {
				mousePos(e);
				drw();
				savePos();
			});
			canvas.addEventListener("mouseup", function (e) {
				draw = false;
				c.globalAlpha = 1;
				fudesaki(fude.x, fude.y, 10);
				savePos();
			});
			//touch ----------------------------------------
			canvas.addEventListener("touchstart", function (e) {
				draw = true; touchPos(e);
				c.globalAlpha = 1;
				fudesaki(fude.x, fude.y - 5, -5); savePos();
			});
			canvas.addEventListener("touchmove", function (e) {
				e.preventDefault();
				touchPos(e);
				drw();
				savePos();
			});
			canvas.addEventListener("touchend", function (e) {
				draw = false;
				touchPos(e);
				c.globalAlpha = 1;
				if (fude.x != fude2.x) {
					fudesaki(fude.x, fude.y + 5, -5);
				}
				savePos();
			});

			//筆先
			function fudesaki(x, y, d) {//x,y,dは20=痩せ具合
				c.save();
				c.translate(x, y);
				c.rotate(20 / 180 * Math.PI);
				c.scale(1, 0.5);
				c.beginPath();
				c.arc(0, 0, 20 - d, 0, 2 * Math.PI, false);
				c.fill();
				c.restore();
			}

			//描画
			function drw() {
				fude.d = Math.abs((fude2.x - fude.x) / 3);
				if (fude.d >= 20) fude.d = 19;
				var j = 10;
				if (draw) {
					//	c.globalAlpha=1/j;
					for (var i = 1; i <= j; i++) {
						fudesaki(
							fude.x + Math.floor((fude2.x - fude.x) * i / j),
							fude.y + Math.floor((fude2.y - fude.y) * i / j),
							fude.d
						);
					}
					c.closePath();
					c.fill(); c.stroke();
				}
			}

			//マウスの位置を取得
			function mousePos(e) {
				const RECT = e.target.getBoundingClientRect();
				fude.x = e.clientX - RECT.left;
				fude.y = e.clientY - RECT.top;
			}

			//タッチの位置を取得
			function touchPos(e) {
				const RECT = e.target.getBoundingClientRect();
				fude.x = e.touches[0].clientX - RECT.left;
				fude.y = e.touches[0].clientY - RECT.top;
			}

			//移動後の前の位置を保存
			function savePos() {
				fude2.x = fude.x;
				fude2.y = fude.y;
				fude2.d = fude.d;
			}

			//画面クリア
			function clr() {
				c.fillStyle = "white";
				c.fillRect(0, 0, canvas.width, canvas.height);
				c.fillStyle = "black";
				c.shadowBlur = 5;
				c.shadowColor = "black";
			}

			//習字をダウンロード
			function downloadCanvas() {
				let link = document.getElementById('hiddenLink')
				link.href = canvas.toDataURL()

				canvas.src = canvas.toDataURL()

				link.click()
			}
		</script>
	</body>
</html>